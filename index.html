<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>NextGen Terminal 2025</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Fira Code:wght@400;700&display=swap');
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Fira Code', monospace;
    }

    body {
      background: #0a0a0a;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      overflow: hidden;
    }

    canvas#bgCanvas {
      position: fixed;
      top: 0;
      left: 0;
      z-index: -1;
      opacity: 0.3;
    }

    .terminal {
      width: 90%;
      max-width: 800px;
      height: 500px;
      background: rgba(20, 20, 20, 0.95);
      border-radius: 12px;
      box-shadow: 0 0 20px rgba(0, 255, 163, 0.2);
      padding: 20px;
      position: relative;
      z-index: 1;
      transition: filter 0.3s;
    }

    .terminal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px;
      background: #1a1a1a;
      border-radius: 8px 8px 0 0;
    }

    .terminal-buttons {
      display: flex;
      gap: 8px;
    }

    .terminal-button {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: #ff5f57;
    }

    .terminal-button:nth-child(2) { background: #ffbc38; }
    .terminal-button:nth-child(3) { background: #00cc44; }

    .voice-toggle {
      cursor: pointer;
      color: #00ff9f;
      font-size: 12px;
    }

    .terminal-body {
      margin-top: 40px;
      height: calc(100% - 40px);
      overflow-y: auto;
      padding: 20px;
      color: #00ff9f;
      font-size: 14px;
      line-height: 1.5;
    }

    .terminal-input {
      display: flex;
      align-items: center;
      margin-top: 10px;
      position: relative;
    }

    .prompt { color: #00cc44; margin-right: 5px; }

    #terminalInput {
      background: transparent;
      border: none;
      color: #00ff9f;
      font-family: 'Fira Code', monospace;
      font-size: 14px;
      width: 100%;
      outline: none;
    }

    .cursor {
      width: 8px;
      height: 16px;
      background: #00ff9f;
      display: inline-block;
      animation: blink 1s infinite;
    }

    .output { margin: 10px 0; opacity: 0; }

    .suggestions {
      position: absolute;
      top: 100%;
      left: 20px;
      background: rgba(20, 20, 20, 0.9);
      color: #00ff9f;
      border-radius: 4px;
      padding: 5px;
      max-height: 100px;
      overflow-y: auto;
      width: calc(100% - 40px);
      z-index: 2;
      opacity: 0;
    }

    .suggestion-item {
      padding: 5px;
      cursor: pointer;
    }

    .suggestion-item:hover { background: rgba(0, 255, 163, 0.2); }

    @keyframes blink {
      0%, 50% { opacity: 1; }
      51%, 100% { opacity: 0; }
    }

    .terminal-body::-webkit-scrollbar {
      width: 8px;
    }

    .terminal-body::-webkit-scrollbar-track { background: #1a1a1a; }
    .terminal-body::-webkit-scrollbar-thumb {
      background: #00cc44;
      border-radius: 4px;
    }

    .suggestions::-webkit-scrollbar { width: 6px; }
    .suggestions::-webkit-scrollbar-track { background: #1a1a1a; }
    .suggestions::-webkit-scrollbar-thumb { background: #00cc44; border-radius: 3px; }

    .light-theme {
      background: rgba(240, 240, 240, 0.95);
      color: #0a0a0a;
    }

    .light-theme .terminal-header { background: #e0e0e0; }
    .light-theme .prompt { color: #007bff; }
    .light-theme #terminalInput { color: #0a0a0a; }
    .light-theme .cursor { background: #007bff; }
    .light-theme .suggestions { background: rgba(240, 240, 240, 0.9); color: #0a0a0a; }
    .light-theme .suggestion-item:hover { background: rgba(0, 123, 255, 0.2); }
    .light-theme::-webkit-scrollbar-thumb { background: #007bff; }

    .crt-effect {
      filter: url(#crtScanlines);
    }

    .neon-blue {
      color: #00b7eb;
      box-shadow: 0 0 20px rgba(0, 183, 235, 0.5);
    }

    .neon-blue .prompt { color: #007bff; }
    .neon-blue #terminalInput { color: #00b7eb; }
    .neon-blue .cursor { background: #00b7eb; }
    .neon-blue .terminal-header { background: #1a3c4f; }
    .neon-blue .suggestions { background: rgba(20, 60, 79, 0.9); }
    .neon-blue .suggestion-item:hover { background: rgba(0, 183, 235, 0.3); }

    .neon-pink {
      color: #ff007f;
      box-shadow: 0 0 20px rgba(255, 0, 127, 0.5);
    }

    .neon-pink .prompt { color: #c6005e; }
    .neon-pink #terminalInput { color: #ff007f; }
    .neon-pink .cursor { background: #ff007f; }
    .neon-pink .terminal-header { background: #4f1a3c; }
    .neon-pink .suggestions { background: rgba(79, 20, 60, 0.9); }
    .neon-pink .suggestion-item:hover { background: rgba(255, 0, 127, 0.3); }

    .glitch {
      animation: glitch 0.2s ease-in-out;
    }

    @keyframes glitch {
      0% { transform: translate(0); }
      20% { transform: translate(-2px, 2px); }
      40% { transform: translate(2px, -2px); }
      60% { transform: translate(-1px, 1px); }
      80% { transform: translate(1px, -1px); }
      100% { transform: translate(0); }
    }

    @media (max-width: 600px) {
      .terminal { width: 95%; height: 80vh; }
      .terminal-body { font-size: 12px; }
      .suggestions { font-size: 12px; }
    }
  </style>
  <svg style="display: none;">
    <filter id="crtScanlines">
      <feTurbulence type="fractalNoise" baseFrequency="0.01" numOctaves="1" result="noise" />
      <feDisplacementMap in="SourceGraphic" in2="noise" scale="2" xChannelSelector="R" yChannelSelector="G" />
      <feColorMatrix type="matrix" values="1 0 0 0 0  0 1 0 0 0  0 0 1 0 0  0 0 0 0.8 0" />
    </filter>
  </svg>
</head>
<body>
  <canvas id="bgCanvas"></canvas>
  <div class="terminal">
    <div class="terminal-header">
      <div class="terminal-buttons">
        <div class="terminal-button"></div>
        <div class="terminal-button"></div>
        <div class="terminal-button"></div>
      </div>
      <span class="voice-toggle" id="voiceToggle">üéôÔ∏è Voice: Off</span>
    </div>
    <div class="terminal-body" id="terminalBody">
      <div class="output">Welcome to NextGen Terminal 2025</div>
      <div class="output">Type 'help' for commands or toggle voice mode.</div>
      <div class="terminal-input">
        <span class="prompt">$</span>
        <input type="text" id="terminalInput" autocomplete="off">
        <span class="cursor"></span>
        <div class="suggestions" id="suggestions"></div>
      </div>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/gsap.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r134/three.min.js"></script>
  <script>
    // Three.js Background and Visualizations
    const scene = new THREE.Scene();
    const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
    const renderer = new THREE.WebGLRenderer({ canvas: document.getElementById('bgCanvas'), alpha: true });
    renderer.setSize(window.innerWidth, window.innerHeight);

    const geometry = new THREE.BufferGeometry();
    const vertices = [];
    for (let i = 0; i < 1000; i++) {
      vertices.push(
        Math.random() * 200 - 100,
        Math.random() * 200 - 100,
        Math.random() * 200 - 100
      );
    }
    geometry.setAttribute('position', new THREE.Float32BufferAttribute(vertices, 3));
    const material = new THREE.PointsMaterial({ color: 0x00ff9f, size: 0.5 });
    const particles = new THREE.Points(geometry, material);
    scene.add(particles);
    camera.position.z = 100;

    let vizObjects = [];
    let animationSpeed = 0.001;

    function clearViz() {
      vizObjects.forEach(obj => scene.remove(obj));
      vizObjects = [];
    }

    function renderWeatherViz(city, weatherData) {
      clearViz();
      const globe = new THREE.Mesh(
        new THREE.SphereGeometry(10, 32, 32),
        new THREE.MeshBasicMaterial({ color: 0x00ff9f, wireframe: true })
      );
      scene.add(globe);
      vizObjects.push(globe);
      const cloudGeometry = new THREE.BufferGeometry();
      const cloudVertices = [];
      for (let i = 0; i < 50; i++) {
        cloudVertices.push(
          Math.random() * 20 - 10,
          Math.random() * 20 - 10,
          Math.random() * 20 - 10
        );
      }
      cloudGeometry.setAttribute('position', new THREE.Float32BufferAttribute(cloudVertices, 3));
      const cloudMaterial = new THREE.PointsMaterial({ color: 0xffffff, size: 0.5 });
      const clouds = new THREE.Points(cloudGeometry, cloudMaterial);
      scene.add(clouds);
      vizObjects.push(clouds);
      gsap.to(globe.rotation, { y: Math.PI * 2, duration: 10, repeat: -1, ease: 'linear' });
      setTimeout(clearViz, 5000);
    }

    function renderStockViz(symbol, price) {
      clearViz();
      const points = [];
      for (let i = 0; i < 20; i++) {
        points.push(new THREE.Vector3(i - 10, Math.sin(i * 0.5) * 5 + (price % 10), 0));
      }
      const lineGeometry = new THREE.BufferGeometry().setFromPoints(points);
      const lineMaterial = new THREE.LineBasicMaterial({ color: 0x00ff9f });
      const line = new THREE.Line(lineGeometry, lineMaterial);
      scene.add(line);
      vizObjects.push(line);
      gsap.to(line.rotation, { y: Math.PI, duration: 8, repeat: -1, ease: 'power2.inOut' });
      setTimeout(clearViz, 5000);
    }

    function renderDateViz() {
      clearViz();
      const clock = new THREE.Mesh(
        new THREE.CircleGeometry(10, 32),
        new THREE.MeshBasicMaterial({ color: 0x00ff9f, wireframe: true })
      );
      scene.add(clock);
      vizObjects.push(clock);
      const hourHand = new THREE.Mesh(
        new THREE.BoxGeometry(1, 5, 0.1),
        new THREE.MeshBasicMaterial({ color: 0xffffff })
      );
      hourHand.position.y = 2.5;
      scene.add(hourHand);
      vizObjects.push(hourHand);
      const now = new Date();
      const hours = now.getHours() % 12;
      const minutes = now.getMinutes();
      gsap.to(hourHand.rotation, { z: -(hours + minutes / 60) * Math.PI / 6, duration: 1, ease: 'power2.out' });
      setTimeout(clearViz, 5000);
    }

    function renderStarsAnimation(speed) {
      clearViz();
      const starGeometry = new THREE.BufferGeometry();
      const starVertices = [];
      for (let i = 0; i < 200; i++) {
        starVertices.push(
          Math.random() * 50 - 25,
          Math.random() * 50 - 25,
          Math.random() * 50 - 25
        );
      }
      starGeometry.setAttribute('position', new THREE.Float32BufferAttribute(starVertices, 3));
      const starMaterial = new THREE.PointsMaterial({ color: 0x00ff9f, size: 0.7 });
      const stars = new THREE.Points(starGeometry, starMaterial);
      scene.add(stars);
      vizObjects.push(stars);
      animationSpeed = speed || 0.005;
    }

    function animateParticles() {
      particles.rotation.y += animationSpeed;
      vizObjects.forEach(obj => {
        if (obj.type === 'Points') obj.rotation.y += animationSpeed;
      });
      renderer.render(scene, camera);
      requestAnimationFrame(animateParticles);
    }
    animateParticles();

    // Terminal Logic
    const terminalBody = document.getElementById('terminalBody');
    let terminalInput = document.getElementById('terminalInput');
    const voiceToggle = document.getElementById('voiceToggle');
    const suggestions = document.getElementById('suggestions');
    let commandHistory = JSON.parse(localStorage.getItem('commandHistory') || '[]');
    let historyIndex = commandHistory.length;
    let recognition;
    let aiSuggestionsEnabled = true;
    let crtEffectEnabled = false;
    let neonTheme = 'default';
    let tutorialStep = 0;
    const tutorialSteps = [
      { command: 'help', description: 'Lists all available commands.' },
      { command: 'weather Tokyo', description: 'Fetches weather data for a city.' },
      { command: 'theme', description: 'Toggles between dark and light themes.' },
      { command: 'animate stars', description: 'Triggers a starfield animation.' }
    ];

    // AI-Powered Suggestions
    const commandFrequencies = JSON.parse(localStorage.getItem('commandFrequencies') || '{}');
    function updateCommandFrequency(command) {
      commandFrequencies[command] = (commandFrequencies[command] || 0) + 1;
      localStorage.setItem('commandFrequencies', JSON.stringify(commandFrequencies));
    }

    function getAISuggestions(input) {
      const commands = Object.keys(commandFrequencies);
      const sortedCommands = commands.sort((a, b) => commandFrequencies[b] - commandFrequencies[a]);
      return sortedCommands.filter(cmd => cmd.startsWith(input.toLowerCase())).slice(0, 3);
    }

    // Trie for Autocomplete
    const trie = {
      children: {},
      isEnd: false,
      insert(word) {
        let node = this;
        for (let char of word) {
          if (!node.children[char]) node.children[char] = { children: {}, isEnd: false };
          node = node.children[char];
        }
        node.isEnd = true;
      },
      getSuggestions(prefix) {
        let node = this;
        for (let char of prefix) {
          if (!node.children[char]) return [];
          node = node.children[char];
        }
        return this.collectWords(node, prefix);
      },
      collectWords(node, prefix, words = []) {
        if (node.isEnd) words.push(prefix);
        for (let char in node.children) {
          this.collectWords(node.children[char], prefix + char, words);
        }
        return words;
      }
    };

    // API Configuration
    const config = {
      openWeatherMapApiKey: '204029892e172ef4690b2cefc641528f',
      alphaVantageApiKey: 'VINMFIYFJ1P087M1'
    };

    // Sound Effects
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    function playSound(frequency, type = 'sine', duration = 0.1) {
      const oscillator = audioCtx.createOscillator();
      const gainNode = audioCtx.createGain();
      oscillator.connect(gainNode);
      gainNode.connect(audioCtx.destination);
      oscillator.type = type;
      oscillator.frequency.setValueAtTime(frequency, audioCtx.currentTime);
      gainNode.gain.setValueAtTime(0.1, audioCtx.currentTime);
      oscillator.start();
      gainNode.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + duration);
      oscillator.stop(audioCtx.currentTime + duration);
    }

    // Voice Recognition
    if ('webkitSpeechRecognition' in window) {
      recognition = new webkitSpeechRecognition();
      recognition.continuous = false;
      recognition.interimResults = false;
      recognition.onresult = (event) => {
        const command = event.results[0][0].transcript.trim().toLowerCase();
        if (command.includes('stars faster')) {
          animationSpeed = Math.min(animationSpeed + 0.005, 0.02);
          renderStarsAnimation(animationSpeed);
          handleCommand('animate stars');
        } else if (command.includes('stars slower')) {
          animationSpeed = Math.max(animationSpeed - 0.005, 0.001);
          renderStarsAnimation(animationSpeed);
          handleCommand('animate stars');
        } else if (command.includes('stars brighter')) {
          material.size = Math.min(material.size + 0.1, 1.0);
          handleCommand('animate stars');
        } else {
          handleCommand(command);
        }
        voiceToggle.textContent = 'üéôÔ∏è Voice: Off';
        recognition.stop();
      };
      voiceToggle.addEventListener('click', () => {
        if (voiceToggle.textContent.includes('Off')) {
          voiceToggle.textContent = 'üéôÔ∏è Voice: On';
          recognition.start();
        } else {
          voiceToggle.textContent = 'üéôÔ∏è Voice: Off';
          recognition.stop();
        }
      });
    } else {
      voiceToggle.style.display = 'none';
    }

    // Plugin System
    let plugins = JSON.parse(localStorage.getItem('plugins') || '{}');
    function loadPlugin(name, url) {
      return new Promise((resolve, reject) => {
        const script = document.createElement('script');
        script.src = url;
        script.onload = () => {
          if (window.pluginCommands && window.pluginCommands[name]) {
            commands[name] = window.pluginCommands[name];
            trie.insert(name);
            plugins[name] = url;
            localStorage.setItem('plugins', JSON.stringify(plugins));
            resolve(`Plugin ${name} loaded successfully.`);
          } else {
            reject(`Plugin ${name} failed to load: Invalid plugin format.`);
          }
        };
        script.onerror = () => reject(`Plugin ${name} failed to load: Invalid URL.`);
        document.body.appendChild(script);
      });
    }

    // Tutorial
    function startTutorial() {
      terminalBody.innerHTML = `<div class="output">Tutorial: Type the highlighted command or press Enter to proceed.</div>`;
      showTutorialStep();
    }

    function showTutorialStep() {
      if (tutorialStep >= tutorialSteps.length) {
        terminalBody.innerHTML = `<div class="output">Tutorial completed!</div>
          <div class="terminal-input">
            <span class="prompt">$</span>
            <input type="text" id="terminalInput" autocomplete="off">
            <span class="cursor"></span>
            <div class="suggestions" id="suggestions"></div>
          </div>`;
        terminalInput = document.getElementById('terminalInput');
        setInputListener();
        terminalInput.focus();
        tutorialStep = 0;
        return;
      }
      const step = tutorialSteps[tutorialStep];
      const outputDiv = document.createElement('div');
      outputDiv.className = 'output';
      outputDiv.innerHTML = `<span style="color: #ff007f">${step.command}</span> - ${step.description}`;
      terminalBody.appendChild(outputDiv);
      gsap.fromTo(outputDiv, { opacity: 0, y: 10 }, { opacity: 1, y: 0, duration: 0.5, ease: 'power2.out' });
      terminalBody.scrollTop = terminalBody.scrollHeight;
      terminalInput = document.createElement('input');
      terminalInput.type = 'text';
      terminalInput.id = 'terminalInput';
      terminalInput.autocomplete = 'off';
      const inputContainer = document.createElement('div');
      inputContainer.className = 'terminal-input';
      inputContainer.innerHTML = `<span class="prompt">$</span>`;
      inputContainer.appendChild(terminalInput);
      inputContainer.innerHTML += `<span class="cursor"></span><div class="suggestions" id="suggestions"></div>`;
      terminalBody.appendChild(inputContainer);
      setInputListener();
      terminalInput.focus();
      gsap.fromTo(terminalInput, { opacity: 0 }, { opacity: 1, duration: 0.5 });
    }

    // Commands
    const commands = {
      help: () => `Available commands:
  whoami - Display user info
  about - About this terminal
  clear - Clear the terminal
  date - Show current date
  theme - Toggle dark/light theme
  art rocket - Display rocket ASCII art
  weather <city> - Fetch weather data
  stock <symbol> - Fetch stock price (e.g., stock AAPL)
  liststocks - List popular stock symbols
  ai on/off - Toggle AI-powered suggestions
  effect crt on/off - Toggle CRT effect
  neon default/blue/pink - Set neon color scheme
  animate stars - Start starfield animation
  plugin add <name> <url> - Add a plugin
  plugin list - List installed plugins
  plugin remove <name> - Remove a plugin
  tutorial - Start interactive tutorial`,
      whoami: () => 'user@nextgen2025',
      about: () => 'NextGen Terminal 2025: A futuristic CLI with 3D visualizations, voice-controlled animations, AI suggestions, and plugins. Created by Yash Nigam.',
      clear: () => {
        terminalBody.innerHTML = `<div class="terminal-input">
          <span class="prompt">$</span>
          <input type="text" id="terminalInput" autocomplete="off">
          <span class="cursor"></span>
          <div class="suggestions" id="suggestions"></div>
        </div>`;
        terminalInput = document.getElementById('terminalInput');
        setInputListener();
        terminalInput.focus();
        clearViz();
        return '';
      },
      date: () => {
        renderDateViz();
        return new Date().toLocaleString('en-US', { timeZone: 'Asia/Kolkata' });
      },
      theme: () => {
        document.querySelector('.terminal').classList.toggle('light-theme');
        material.color.set(document.querySelector('.terminal').classList.contains('light-theme') ? 0x007bff : 0x00ff9f);
        return 'Theme toggled!';
      },
      art: (arg) => arg === 'rocket' ? `
        ^  ^
       / 0  \\
      ( ===  )
       '---' ` : 'Unknown art. Try "art rocket".',
      weather: async (city) => {
        if (!city) return 'Please provide a city name.';
        try {
          const res = await fetch(`https://api.openweathermap.org/data/2.5/weather?q=${city}&appid=${config.openWeatherMapApiKey}&units=metric`);
          const data = await res.json();
          if (data.cod === 404) return `City not found. Please check the city name (e.g., "London,UK").`;
          if (data.cod === 401) return `Invalid API key. Contact the administrator.`;
          if (data.cod !== 200) return `Error: ${data.message}.`;
          renderWeatherViz(city, data);
          return `Weather in ${city}: ${data.weather[0].description}, ${Math.round(data.main.temp)}¬∞C, Humidity: ${data.main.humidity}%`;
        } catch (e) {
          return 'Error fetching weather data.';
        }
      },
      stock: async (symbol) => {
        if (!symbol) return 'Please provide a stock symbol (e.g., "stock AAPL").';
        if (symbol.toLowerCase() === 'google') return `Did you mean "GOOGL"? Try "stock GOOGL".`;
        try {
          const res = await fetch(`https://www.alphavantage.co/query?function=GLOBAL_QUOTE&symbol=${symbol}&apikey=${config.alphaVantageApiKey}`);
          const data = await res.json();
          if (data['Error Message']) return `Invalid stock symbol (e.g., "AAPL").`;
          if (data['Note']) return `API rate limit reached. Try again later.`;
          const quote = data['Global Quote'];
          if (!quote || !quote['01. symbol']) return `No data for ${symbol}. Try a valid symbol.`;
          renderStockViz(symbol, parseFloat(quote['05. price']));
          return `Stock ${quote['01. symbol']}: $${parseFloat(quote['05. price']).toFixed(2)}, Change: ${parseFloat(quote['09. change']).toFixed(2)} (${quote['10. change percent']})`;
        } catch (e) {
          return 'Error fetching stock data.';
        }
      },
      liststocks: async () => {
        try {
          const res = await fetch(`https://www.alphavantage.co/query?function=LISTING_STATUS&apikey=${config.alphaVantageApiKey}`);
          const text = await res.text();
          const lines = text.split('\n').slice(1, 11);
          if (!lines.length) return 'No stock data available.';
          const stocks = lines.map(line => {
            const [symbol, name] = line.split(',').slice(0, 2);
            return `${symbol}: ${name}`;
          });
          return `Popular Stocks (Top 10):\n${stocks.join('\n')}\nNote: Limited to 10 due to API constraints.`;
        } catch (e) {
          return 'Error fetching stock list.';
        }
      },
      ai: (arg) => {
        if (arg === 'on') {
          aiSuggestionsEnabled = true;
          return 'AI suggestions enabled.';
        } else if (arg === 'off') {
          aiSuggestionsEnabled = false;
          return 'AI suggestions disabled.';
        }
        return 'Usage: ai on/off';
      },
      effect: (arg) => {
        if (arg === 'crt on') {
          crtEffectEnabled = true;
          document.querySelector('.terminal').classList.add('crt-effect');
          return 'CRT effect enabled.';
        } else if (arg === 'crt off') {
          crtEffectEnabled = false;
          document.querySelector('.terminal').classList.remove('crt-effect');
          return 'CRT effect disabled.';
        }
        return 'Usage: effect crt on/off';
      },
      neon: (arg) => {
        const terminal = document.querySelector('.terminal');
        terminal.classList.remove('neon-blue', 'neon-pink');
        if (arg === 'blue') {
          neonTheme = 'blue';
          terminal.classList.add('neon-blue');
          material.color.set(0x00b7eb);
          return 'Neon blue theme applied.';
        } else if (arg === 'pink') {
          neonTheme = 'pink';
          terminal.classList.add('neon-pink');
          material.color.set(0xff007f);
          return 'Neon pink theme applied.';
        } else if (arg === 'default') {
          neonTheme = 'default';
          material.color.set(terminal.classList.contains('light-theme') ? 0x007bff : 0x00ff9f);
          return 'Default theme applied.';
        }
        return 'Usage: neon default/blue/pink';
      },
      animate: (arg) => {
        if (arg === 'stars') {
          renderStarsAnimation();
          return 'Starfield animation started. Use voice commands: "stars faster", "stars slower", "stars brighter".';
        }
        return 'Usage: animate stars';
      },
      plugin: async (arg) => {
        const [action, name, url] = arg.split(' ');
        if (action === 'add' && name && url) {
          try {
            const result = await loadPlugin(name, url);
            return result;
          } catch (e) {
            return e;
          }
        } else if (action === 'list') {
          return Object.keys(plugins).length ? `Installed plugins:\n${Object.keys(plugins).join('\n')}` : 'No plugins installed.';
        } else if (action === 'remove' && name) {
          if (plugins[name]) {
            delete commands[name];
            delete plugins[name];
            localStorage.setItem('plugins', JSON.stringify(plugins));
            trie.children = {};
            Object.keys(commands).forEach(cmd => trie.insert(cmd));
            return `Plugin ${name} removed.`;
          }
          return `Plugin ${name} not found.`;
        }
        return 'Usage: plugin add <name> <url> | plugin list | plugin remove <name>';
      },
      tutorial: () => {
        startTutorial();
        return '';
      }
    };

    // Initialize Trie
    Object.keys(commands).forEach(cmd => trie.insert(cmd));

    // Handle Command
    function handleCommand(input) {
      playSound(440, 'square', 0.05);
      updateCommandFrequency(input);
      const [cmd, ...args] = input.toLowerCase().split(' ');
      const outputDiv = document.createElement('div');
      outputDiv.className = 'output';
      const commandResult = commands[cmd] ? commands[cmd](args.join(' ')) : `Command not found: ${input}`;
      
      const inputContainer = terminalBody.querySelector('.terminal-input');
      if (!inputContainer) {
        console.error('Terminal input container not found. Reinitializing.');
        commands.clear();
        return;
      }

      if (tutorialStep < tutorialSteps.length && input === tutorialSteps[tutorialStep].command) {
        tutorialStep++;
        showTutorialStep();
      } else if (tutorialStep < tutorialSteps.length && input === '') {
        tutorialStep++;
        showTutorialStep();
      }

      if (commandResult instanceof Promise) {
        outputDiv.textContent = 'Fetching...';
        terminalBody.insertBefore(outputDiv, inputContainer);
        gsap.fromTo(outputDiv, { opacity: 0, y: 10 }, { opacity: 1, y: 0, duration: 0.5, ease: 'power2.out' });
        commandResult.then(result => {
          outputDiv.textContent = result;
          gsap.fromTo(outputDiv, { opacity: 0 }, { opacity: 1, duration: 0.5, ease: 'power2.out' });
          if (neonTheme !== 'default') {
            gsap.to(outputDiv, { className: 'output glitch', duration: 0.2, repeat: 1, yoyo: true });
          }
        });
      } else if (commandResult !== '') {
        outputDiv.textContent = commandResult;
        terminalBody.insertBefore(outputDiv, inputContainer);
        gsap.fromTo(outputDiv, { opacity: 0, y: 10 }, { opacity: 1, y: 0, duration: 0.5, ease: 'power2.out' });
        if (neonTheme !== 'default') {
          gsap.to(outputDiv, { className: 'output glitch', duration: 0.2, repeat: 1, yoyo: true });
        }
      }

      terminalBody.scrollTop = terminalBody.scrollHeight;
      terminalInput.value = '';
      suggestions.innerHTML = '';
      gsap.to(suggestions, { opacity: 0, duration: 0.3 });

      commandHistory.push(input);
      localStorage.setItem('commandHistory', JSON.stringify(commandHistory));
      historyIndex = commandHistory.length;

      gsap.to(particles.material, { size: 1, duration: 0.2, yoyo: true, repeat: 1 });
    }

    // Autocomplete Suggestions
    let debounceTimeout;
    function showSuggestions(input) {
      clearTimeout(debounceTimeout);
      debounceTimeout = setTimeout(() => {
        suggestions.innerHTML = '';
        if (input) {
          let matches = trie.getSuggestions(input.toLowerCase());
          if (aiSuggestionsEnabled) {
            matches = [...new Set([...matches, ...getAISuggestions(input)])].slice(0, 5);
          }
          if (matches.length) {
            matches.forEach(match => {
              const div = document.createElement('div');
              div.className = 'suggestion-item';
              div.textContent = match;
              div.addEventListener('click', () => {
                terminalInput.value = match;
                suggestions.innerHTML = '';
                gsap.to(suggestions, { opacity: 0, duration: 0.3 });
                terminalInput.focus();
              });
              suggestions.appendChild(div);
            });
            gsap.fromTo(suggestions, { opacity: 0, y: 5 }, { opacity: 1, y: 0, duration: 0.3, ease: 'power2.out' });
          }
        }
      }, 100);
    }

    // Input Listener
    function setInputListener() {
      terminalInput = document.getElementById('terminalInput');
      terminalInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && terminalInput.value.trim()) {
          handleCommand(terminalInput.value.trim());
        } else if (e.key === 'ArrowUp' && historyIndex > 0) {
          historyIndex--;
          terminalInput.value = commandHistory[historyIndex] || '';
          showSuggestions(terminalInput.value);
        } else if (e.key === 'ArrowDown' && historyIndex < commandHistory.length - 1) {
          historyIndex++;
          terminalInput.value = commandHistory[historyIndex] || '';
          showSuggestions(terminalInput.value);
        }
      });
      terminalInput.addEventListener('input', () => {
        playSound(880, 'sine', 0.03);
        showSuggestions(terminalInput.value);
      });
    }

    // Initialize
    gsap.from('.terminal', { scale: 0.8, opacity: 0, duration: 1, ease: 'back.out(1.7)' });
    document.querySelectorAll('.output').forEach((output, index) => {
      gsap.fromTo(output, { opacity: 0, y: 10 }, { opacity: 1, y: 0, duration: 0.5, delay: index * 0.3, ease: 'power2.out' });
    });
    setInputListener();
    terminalInput.focus();
  </script>
</body>
</html>